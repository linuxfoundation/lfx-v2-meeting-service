# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
apiVersion: heimdall.dadrus.github.com/v1alpha4
kind: RuleSet
metadata:
  name: {{ .Chart.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  rules:
    - id: "rule:lfx:lfx-v2-meeting-service:openapi:get"
      match:
        methods:
          - GET
        routes:
          - path: /_meetings/openapi.json
          - path: /_meetings/openapi.yaml
          - path: /_meetings/openapi3.json
          - path: /_meetings/openapi3.yaml
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        - authorizer: allow_all
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    # =============== ITX Zoom API Proxy Endpoints ==================
    # These endpoints proxy requests to the ITX Zoom API service

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:create"
      match:
        methods:
          - POST
        routes:
          - path: /itx/meetings
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: json_content_type
        - authorizer: openfga_check
          config:
            values:
              relation: writer
              object: "project:{{ "{{- .Request.Body.project_uid -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:get"
      match:
        methods:
          - GET
        routes:
          - path: /itx/meetings/:meeting_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: viewer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:update"
      match:
        methods:
          - PUT
        routes:
          - path: /itx/meetings/:meeting_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:delete"
      match:
        methods:
          - DELETE
        routes:
          - path: /itx/meetings/:meeting_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meeting_count:get"
      match:
        methods:
          - GET
        routes:
          - path: /itx/meeting_count
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: viewer
              object: "project:{{ "{{- .Request.URL.Query.project_uid -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:join_link"
      match:
        methods:
          - GET
        routes:
          - path: /itx/meetings/:meeting_id/join_link
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: viewer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:resend_invitations"
      match:
        methods:
          - POST
        routes:
          - path: /itx/meetings/:meeting_id/resend
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:create"
      match:
        methods:
          - POST
        routes:
          - path: /itx/meetings/:meeting_id/registrants
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:get"
      match:
        methods:
          - GET
        routes:
          - path: /itx/meetings/:meeting_id/registrants/:registrant_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: auditor
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:update"
      match:
        methods:
          - PUT
        routes:
          - path: /itx/meetings/:meeting_id/registrants/:registrant_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:delete"
      match:
        methods:
          - DELETE
        routes:
          - path: /itx/meetings/:meeting_id/registrants/:registrant_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:get_ics"
      match:
        methods:
          - GET
        routes:
          - path: /itx/meetings/:meeting_id/registrants/:registrant_id/ics
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: viewer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:registrants:resend_invitation"
      match:
        methods:
          - POST
        routes:
          - path: /itx/meetings/:meeting_id/registrants/:registrant_id/resend
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:meetings:register_committee_members"
      match:
        methods:
          - POST
        routes:
          - path: /itx/meetings/:meeting_id/register_committee_members
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:occurrences:update"
      match:
        methods:
          - PUT
        routes:
          - path: /itx/meetings/:meeting_id/occurrences/:occurrence_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}

    - id: "rule:lfx:lfx-v2-meeting-service:itx:occurrences:delete"
      match:
        methods:
          - DELETE
        routes:
          - path: /itx/meetings/:meeting_id/occurrences/:occurrence_id
      allow_encoded_slashes: "off"
      execute:
        - authenticator: oidc
        - authenticator: anonymous_authenticator
        {{- if .Values.app.use_oidc_contextualizer }}
        - contextualizer: oidc_contextualizer
        {{- end }}
        {{- if .Values.openfga.enabled }}
        - authorizer: openfga_check
          config:
            values:
              relation: organizer
              object: "meeting:{{ "{{- .Request.URL.Captures.meeting_id -}}" }}"
        {{- else }}
        {{/*
          When OpenFGA is disabled, allow all requests
          (Only meant for *local development* because OpenFGA should be enabled when deployed)
        */}}
        - authorizer: allow_all
        {{- end }}
        - finalizer: create_jwt
          config:
            values:
              aud: {{ .Values.app.audience }}
