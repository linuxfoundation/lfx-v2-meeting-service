# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
# Configuration for the base lfx-service chart
lfx-service:
  # Global configuration
  global:
    domain: ""
    namespace: ""

  # Image configuration
  image:
    repository: ghcr.io/linuxfoundation/lfx-one-meeting-service/meeting-api
    tag: "1.0"

  # Deployment configuration
  deployment:
    # Environment variables using the new format
    environment:
      NATS_URL:
        value: "nats://lfx-platform-nats.lfx.svc.cluster.local:4222"
      LOG_LEVEL:
        value: "info"
      LOG_ADD_SOURCE:
        value: "true"
      JWKS_URL:
        value: "http://lfx-platform-heimdall.lfx.svc.cluster.local:4457/.well-known/jwks"
      JWT_AUDIENCE:
        value: "lfx-v2-meeting-service"
      SKIP_ETAG_VALIDATION:
        value: "false"
      JWT_AUTH_DISABLED_MOCK_LOCAL_PRINCIPAL:
        value: ""
      EMAIL_ENABLED:
        value: "true"
      SMTP_HOST:
        value: "lfx-platform-mailpit-smtp.lfx.svc.cluster.local"
      SMTP_PORT:
        value: "25"
      SMTP_FROM:
        value: "noreply@lfx.linuxfoundation.org"
      SMTP_USERNAME:
        value: ""
      SMTP_PASSWORD:
        value: ""
      ZOOM_ACCOUNT_ID:
        value: ""
      ZOOM_CLIENT_ID:
        value: ""
      ZOOM_CLIENT_SECRET:
        value: ""
      ZOOM_WEBHOOK_SECRET_TOKEN:
        value: ""
      LFX_ENVIRONMENT:
        value: ""

  # HTTPRoute configuration
  httpRoute:
    enabled: true
    gateway:
      name: lfx-platform-gateway
      namespace: lfx
    
    matches:
      - path:
          type: Exact
          value: /meetings
      - path:
          type: PathPrefix
          value: /meetings/
      - path:
          type: Exact
          value: /past_meetings
      - path:
          type: PathPrefix
          value: /past_meetings/
      - path:
          type: PathPrefix
          value: /webhooks/
      - path:
          type: PathPrefix
          value: /_meetings/

    filters:
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: heimdall-forward-body

  # Heimdall middleware
  heimdall:
    enabled: true
    url: http://lfx-platform-heimdall.lfx.svc.cluster.local:4456
    createMiddleware: true

  # RuleSet for authentication
  ruleSet:
    enabled: true
    audience: lfx-v2-meeting-service
    
    rules:
      # OpenAPI endpoints
      - id: "rule:lfx:lfx-v2-meeting-service:openapi:get"
        match:
          methods: ["GET"]
          routes:
            - "/_meetings/openapi.json"
            - "/_meetings/openapi.yaml"
            - "/_meetings/openapi3.json"
            - "/_meetings/openapi3.yaml"
        # No authorization required for OpenAPI docs

      # Zoom webhook endpoint
      - id: "rule:lfx:lfx-v2-meeting-service:webhooks:zoom"
        match:
          methods: ["POST"]
          routes: ["/webhooks/zoom"]
        # No authorization - endpoint validates Zoom signature

      # Meeting operations
      - id: "rule:lfx:lfx-v2-meeting-service:meetings:create"
        match:
          methods: ["POST"]
          routes: ["/meetings"]
        authorization:
          requireJsonContent: true
          relation: writer
          object: "project:{{.Request.Body.project_uid}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meetings:meeting:get"
        match:
          methods: ["GET"]
          routes: ["/meetings/:id"]
        authorization:
          relation: viewer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meetings:meeting:join_url"
        match:
          methods: ["GET"]
          routes: ["/meetings/:id/join_url"]
        authorization:
          relation: viewer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_settings:get"
        match:
          methods: ["GET"]
          routes: ["/meetings/:id/settings"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meetings:meeting:update"
        match:
          methods: ["PUT"]
          routes: ["/meetings/:id"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_settings:update"
        match:
          methods: ["PUT"]
          routes: ["/meetings/:id/settings"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meetings:meeting:delete"
        match:
          methods: ["DELETE"]
          routes: ["/meetings/:id"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      # Meeting registrants
      - id: "rule:lfx:lfx-v2-meeting-service:meeting_registrants:create"
        match:
          methods: ["POST"]
          routes: ["/meetings/:id/registrants"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_registrants:list"
        match:
          methods: ["GET"]
          routes: ["/meetings/:id/registrants"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_registrants:update"
        match:
          methods: ["PUT"]
          routes: ["/meetings/:id/registrants/:registrant_id"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_registrants:get"
        match:
          methods: ["GET"]
          routes: ["/meetings/:id/registrants/:registrant_id"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:meeting_registrants:delete"
        match:
          methods: ["DELETE"]
          routes: ["/meetings/:id/registrants/:registrant_id"]
        authorization:
          relation: organizer
          object: "meeting:{{.Request.URL.Captures.id}}"

      # Past meetings
      - id: "rule:lfx:lfx-v2-meeting-service:past_meetings:create"
        match:
          methods: ["POST"]
          routes: ["/past_meetings"]
        authorization:
          requireJsonContent: true
          relation: writer
          object: "project:{{.Request.Body.project_uid}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meetings:list"
        match:
          methods: ["GET"]
          routes: ["/past_meetings"]
        # Allow all for development endpoint

      - id: "rule:lfx:lfx-v2-meeting-service:past_meetings:past_meeting:get"
        match:
          methods: ["GET"]
          routes: ["/past_meetings/:id"]
        authorization:
          relation: viewer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meetings:past_meeting:delete"
        match:
          methods: ["DELETE"]
          routes: ["/past_meetings/:id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      # Past meeting participants
      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_participants:create"
        match:
          methods: ["POST"]
          routes: ["/past_meetings/:id/participants"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_participants:list"
        match:
          methods: ["GET"]
          routes: ["/past_meetings/:id/participants"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_participants:update"
        match:
          methods: ["PUT"]
          routes: ["/past_meetings/:id/participants/:participant_id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_participants:get"
        match:
          methods: ["GET"]
          routes: ["/past_meetings/:id/participants/:participant_id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_participants:delete"
        match:
          methods: ["DELETE"]
          routes: ["/past_meetings/:id/participants/:participant_id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      # Past meeting summaries
      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_summaries:list"
        match:
          methods: ["GET"]
          routes: ["/past_meetings/:id/summaries"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_summaries:update"
        match:
          methods: ["PUT"]
          routes: ["/past_meetings/:id/summaries/:summary_id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

      - id: "rule:lfx:lfx-v2-meeting-service:past_meeting_summaries:get"
        match:
          methods: ["GET"]
          routes: ["/past_meetings/:id/summaries/:summary_id"]
        authorization:
          relation: organizer
          object: "past_meeting:{{.Request.URL.Captures.id}}"

  # NATS KV Buckets
  nats:
    kvBuckets:
      - name: meetings
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 1073741824    # 1GB
        compression: true

      - name: meeting-settings
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 1073741824    # 1GB
        compression: true

      - name: meeting-registrants
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 1073741824    # 1GB
        compression: true

      - name: past-meetings
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 5368709120    # 5GB
        compression: true

      - name: past-meeting-participants
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 5368709120    # 5GB
        compression: true

      - name: past-meeting-recordings
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 10737418240   # 10GB
        compression: true

      - name: past-meeting-summaries
        creation: true
        keep: true
        history: 20
        storage: file
        maxValueSize: 10485760  # 10MB
        maxBytes: 1073741824    # 1GB
        compression: true